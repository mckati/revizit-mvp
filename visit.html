<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Revizit - Ziyaret</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body class="bg-neutral-100 flex items-center justify-center min-h-screen">

<div class="bg-white w-[360px] rounded-3xl shadow-xl p-6 text-center space-y-6">

  <h1 class="text-2xl font-semibold">Ziyaret OnayÄ±</h1>

  <div id="phoneArea" class="hidden space-y-4">

    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-4 w-full rounded-xl text-center text-lg"/>

    <button id="confirmBtn"
      onclick="completeVisit()"
      disabled
      class="bg-gray-300 text-white px-4 py-3 rounded-xl w-full">
      Onayla
    </button>

  </div>

  <div id="cupArea" class="hidden">

    <div class="relative w-48 mx-auto mb-4">

      <svg viewBox="0 0 200 200" class="w-full">
        <path d="M40 50 L160 50 L150 150 L50 150 Z"
              fill="#E5E5E5" stroke="#CFCFCF" stroke-width="3"/>
        <path d="M160 70 Q190 100 160 130"
              fill="none" stroke="#CFCFCF" stroke-width="8"/>
        <clipPath id="cupClip">
          <path d="M40 50 L160 50 L150 150 L50 150 Z"/>
        </clipPath>
        <rect id="coffeeFill"
              x="0"
              y="150"
              width="200"
              height="100"
              fill="#4B2E2B"
              clip-path="url(#cupClip)"/>
      </svg>

    </div>

    <p id="visitText" class="text-lg font-medium mb-1"></p>
    <p id="message" class="text-green-700 font-medium"></p>

  </div>

</div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let tokenData=null;
let tokenValue=null;

const phoneInput=document.getElementById("phone");
const confirmBtn=document.getElementById("confirmBtn");
const coffee=document.getElementById("coffeeFill");

phoneInput.addEventListener("input",function(e){
  let digits=e.target.value.replace(/\D/g,"");
  if(digits.length>11) digits=digits.slice(0,11);

  let formatted="";
  if(digits.length>0) formatted+=digits.substring(0,4);
  if(digits.length>=5) formatted+=" "+digits.substring(4,7);
  if(digits.length>=8) formatted+=" "+digits.substring(7,11);

  e.target.value=formatted;

  confirmBtn.disabled=!/^05\d{9}$/.test(digits);

  if(!confirmBtn.disabled){
    confirmBtn.classList.remove("bg-gray-300");
    confirmBtn.classList.add("bg-black");
  }
});

function cleanPhone(v){ return v.replace(/\D/g,""); }

async function init(){

  tokenValue=new URLSearchParams(window.location.search).get("token");

  const {data,error}=await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token",tokenValue)
    .single();

  if(error || !data){
    document.body.innerHTML="QR geÃ§ersiz.";
    return;
  }

  tokenData=data;

  const savedPhone=localStorage.getItem("revizit_phone_"+data.business_id);

  if(savedPhone){
    completeVisit(savedPhone);
  } else {
    document.getElementById("phoneArea").classList.remove("hidden");
  }
}

async function completeVisit(phoneOverride=null){

  const phone=phoneOverride || cleanPhone(phoneInput.value);
  const businessId=tokenData.business_id;

  let {data:customers}=await supabaseClient
    .from("customers")
    .select("*")
    .eq("business_id",businessId)
    .eq("phone",phone);

  let customer=customers.length>0 ? customers[0] : null;

  if(!customer){
    const {data:newCustomer}=await supabaseClient
      .from("customers")
      .insert({
        phone,
        business_id:businessId,
        reward_available:false,
        reward_progress:1
      })
      .select()
      .single();

    customer=newCustomer;
  }else{

    let progress=customer.reward_progress+1;

    if(progress>=4){
      progress=4;
      await supabaseClient
        .from("customers")
        .update({
          reward_available:true,
          reward_progress:4
        })
        .eq("id",customer.id);
    }else{
      await supabaseClient
        .from("customers")
        .update({
          reward_progress:progress
        })
        .eq("id",customer.id);
    }

    customer.reward_progress=progress;
  }

  localStorage.setItem("customer_id",customer.id);
  localStorage.setItem("revizit_phone_"+businessId,phone);

  await supabaseClient.from("visits").insert({
    business_id:businessId,
    customer_id:customer.id
  });

  await supabaseClient
    .from("qr_tokens")
    .delete()
    .eq("token",tokenValue);

  showCup(customer.reward_progress);
}

function showCup(visits){

  document.getElementById("phoneArea").classList.add("hidden");
  document.getElementById("cupArea").classList.remove("hidden");

  let fillPercent=(visits/4)*100;
  let currentY=150;
  let targetY=150-fillPercent;

  let animation=setInterval(()=>{
    currentY-=2;
    coffee.setAttribute("y",currentY);
    if(currentY<=targetY){
      clearInterval(animation);
    }
  },10);

  document.getElementById("visitText").innerText=
    visits+" / 4 Ziyaret";

  if(visits===4){
    document.getElementById("message").innerText=
      "Yeni Ã¶dÃ¼l kazandÄ±nÄ±z! ðŸŽ‰";

    confetti({
      particleCount:120,
      spread:70,
      origin:{y:0.6}
    });
  }else{
    document.getElementById("message").innerText=
      "Bir adÄ±m daha yaklaÅŸtÄ±nÄ±z â˜•";
  }

  setTimeout(()=>{
    window.location.href="customer.html";
  },3000);
}

init();

</script>

</body>
</html>
