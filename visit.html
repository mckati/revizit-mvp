<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret OnayÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white p-8 rounded-2xl shadow-xl w-96 text-center space-y-6">

  <h1 class="text-xl font-bold">Ziyaret OnayÄ±</h1>

  <div id="phoneArea" class="space-y-3">
    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-2 w-full rounded text-center text-lg tracking-wider"/>
    <button id="confirmBtn"
      onclick="completeVisit()"
      disabled
      class="bg-gray-300 text-white px-4 py-2 rounded w-full cursor-not-allowed">
      Onayla
    </button>
  </div>

  <div id="cupArea" class="hidden flex flex-col items-center space-y-4">

    <div class="relative w-48 h-72">

      <svg viewBox="0 0 200 320" class="w-full h-full">

        <defs>
          <clipPath id="cupClip">
            <path d="M50 40 L150 40 L130 300 L70 300 Z" />
          </clipPath>

          <linearGradient id="coffeeGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#c2410c"/>
            <stop offset="100%" stop-color="#7c2d12"/>
          </linearGradient>
        </defs>

        <!-- Bardak -->
        <path d="M50 40 L150 40 L130 300 L70 300 Z"
              fill="#ffffff"
              stroke="#d1d5db"
              stroke-width="6"/>

        <!-- Seviye Ã‡izgileri -->
        <line x1="70" y1="235" x2="130" y2="235" stroke="#d1d5db" stroke-width="2"/>
        <line x1="70" y1="200" x2="130" y2="200" stroke="#d1d5db" stroke-width="2"/>
        <line x1="70" y1="165" x2="130" y2="165" stroke="#d1d5db" stroke-width="2"/>

        <!-- Kahve -->
        <rect id="coffeeFill"
              x="0"
              y="300"
              width="200"
              height="0"
              fill="url(#coffeeGrad)"
              clip-path="url(#cupClip)"/>
      </svg>
    </div>

    <div id="rewardMessage" class="text-sm font-medium"></div>
  </div>

</div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let tokenData=null;

const phoneInput=document.getElementById("phone");
const confirmBtn=document.getElementById("confirmBtn");

phoneInput.addEventListener("input",function(e){
  let digits=e.target.value.replace(/\D/g,"");
  if(digits.length>11) digits=digits.slice(0,11);

  let formatted="";
  if(digits.length>0) formatted+=digits.substring(0,4);
  if(digits.length>=5) formatted+=" "+digits.substring(4,7);
  if(digits.length>=8) formatted+=" "+digits.substring(7,11);

  e.target.value=formatted;

  confirmBtn.disabled=!/^05\d{9}$/.test(digits);
  if(!confirmBtn.disabled){
    confirmBtn.classList.remove("bg-gray-300","cursor-not-allowed");
    confirmBtn.classList.add("bg-black");
  }
});

function cleanPhone(v){ return v.replace(/\D/g,""); }

async function init(){

  const token=new URLSearchParams(window.location.search).get("token");

  const {data}=await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token",token)
    .single();

  tokenData=data;

  // ðŸ”¥ CÄ°HAZDA DAHA Ã–NCE KAYITLI TELEFON VAR MI?
  const savedPhone=localStorage.getItem("revizit_phone_"+data.business_id);

  if(savedPhone){
    completeVisit(savedPhone,true);
  }
}

async function completeVisit(phoneOverride=null,auto=false){

  const phone=phoneOverride || cleanPhone(phoneInput.value);
  const businessId=tokenData.business_id;

  let {data:customers}=await supabaseClient
    .from("customers")
    .select("*")
    .eq("business_id",businessId)
    .eq("phone",phone);

  let customer=customers.length>0 ? customers[0] : null;

  let progress=0;
  let reward=false;
  let message="";

  if(!customer){

    const {data:newCustomer}=await supabaseClient
      .from("customers")
      .insert({
        phone,
        business_id:businessId,
        reward_available:true,
        reward_progress:4
      })
      .select();

    progress=4;
    reward=true;
    message="ðŸŽ‰ Bir sonraki ziyaretinizde ikinci kahveniz bizden!";
  }
  else{

    if(customer.reward_available){
      progress=1;

      await supabaseClient
        .from("customers")
        .update({
          reward_available:false,
          reward_progress:1
        })
        .eq("id",customer.id);

      message="â˜• Hediyenizi kullandÄ±nÄ±z!";
    }
    else{

      progress=customer.reward_progress+1;

      if(progress>=4){
        reward=true;
        progress=4;

        await supabaseClient
          .from("customers")
          .update({
            reward_available:true,
            reward_progress:4
          })
          .eq("id",customer.id);

        message="ðŸŽ‰ Yeni Ã¶dÃ¼l kazandÄ±nÄ±z!";
      }
      else{
        await supabaseClient
          .from("customers")
          .update({
            reward_progress:progress
          })
          .eq("id",customer.id);

        message=progress+"/4 tamamlandÄ±";
      }
    }
  }

  await supabaseClient
    .from("visits")
    .insert({
      business_id:businessId,
      customer_phone:phone
    });

  localStorage.setItem("revizit_phone_"+businessId,phone);

  animateCup(progress,reward,message);
}

function animateCup(level,celebrate,message){

  document.getElementById("phoneArea").classList.add("hidden");
  document.getElementById("cupArea").classList.remove("hidden");

  const rect=document.getElementById("coffeeFill");

  const cupHeight=260; // 40-300 arasÄ± iÃ§ yÃ¼kseklik
  const targetHeight=(level/4)*cupHeight;

  let current=0;

  const interval=setInterval(()=>{
    current+=5;
    rect.setAttribute("y",300-current);
    rect.setAttribute("height",current);

    if(current>=targetHeight){
      clearInterval(interval);
    }
  },16);

  if(celebrate){
    confetti({particleCount:60,spread:60,origin:{y:0.6}});
  }

  document.getElementById("rewardMessage").innerHTML=message;
}

init();

</script>
</body>
</html>
