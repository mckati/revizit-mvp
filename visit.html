<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white p-8 rounded-xl shadow w-96 text-center space-y-6">

  <h1 class="text-xl font-bold">Ziyaret Onayı</h1>

  <div id="phoneArea" class="hidden space-y-3">
    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-2 w-full rounded text-center"/>
    <button id="confirmBtn"
      onclick="completeVisit()"
      disabled
      class="bg-gray-300 text-white px-4 py-2 rounded w-full">
      Onayla
    </button>
  </div>

  <div id="progressArea" class="hidden space-y-4">

    <div class="grid grid-cols-4 gap-2">
      <div id="p1" class="h-4 rounded bg-gray-200"></div>
      <div id="p2" class="h-4 rounded bg-gray-200"></div>
      <div id="p3" class="h-4 rounded bg-gray-200"></div>
      <div id="p4" class="h-4 rounded bg-gray-200"></div>
    </div>

    <div id="message" class="text-sm font-medium"></div>

  </div>

</div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let tokenData=null;
let tokenValue=null;

const phoneInput=document.getElementById("phone");
const confirmBtn=document.getElementById("confirmBtn");

phoneInput.addEventListener("input",function(e){
  let digits=e.target.value.replace(/\D/g,"");
  if(digits.length>11) digits=digits.slice(0,11);

  let formatted="";
  if(digits.length>0) formatted+=digits.substring(0,4);
  if(digits.length>=5) formatted+=" "+digits.substring(4,7);
  if(digits.length>=8) formatted+=" "+digits.substring(7,11);

  e.target.value=formatted;

  confirmBtn.disabled=!/^05\d{9}$/.test(digits);
  if(!confirmBtn.disabled){
    confirmBtn.classList.remove("bg-gray-300");
    confirmBtn.classList.add("bg-black");
  }
});

function cleanPhone(v){ return v.replace(/\D/g,""); }

async function init(){

  tokenValue=new URLSearchParams(window.location.search).get("token");

  const {data,error}=await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token",tokenValue)
    .single();

  if(error || !data){
    document.body.innerHTML="QR geçersiz.";
    return;
  }

  tokenData=data;

  const savedPhone=localStorage.getItem("revizit_phone_"+data.business_id);

  if(savedPhone){
    completeVisit(savedPhone,true);
  } else {
    document.getElementById("phoneArea").classList.remove("hidden");
  }
}

async function completeVisit(phoneOverride=null,auto=false){

  const phone=phoneOverride || cleanPhone(phoneInput.value);
  const businessId=tokenData.business_id;

  const {data:customers}=await supabaseClient
    .from("customers")
    .select("*")
    .eq("business_id",businessId)
    .eq("phone",phone);

  let customer=customers.length>0 ? customers[0] : null;

  let progress=0;
  let reward=false;
  let message="";

  if(!customer){

    await supabaseClient.from("customers").insert({
      phone,
      business_id:businessId,
      reward_available:true,
      reward_progress:4
    });

    progress=4;
    reward=true;
    message="Bir sonraki ziyaretinizde ikinci kahveniz bizden!";
  }
  else{

    if(customer.reward_available){
      progress=1;

      await supabaseClient
        .from("customers")
        .update({
          reward_available:false,
          reward_progress:1
        })
        .eq("id",customer.id);

      message="Hediyenizi kullandınız!";
    }
    else{

      progress=customer.reward_progress+1;

      if(progress>=4){
        reward=true;
        progress=4;

        await supabaseClient
          .from("customers")
          .update({
            reward_available:true,
            reward_progress:4
          })
          .eq("id",customer.id);

        message="Yeni ödül kazandınız!";
      }
      else{
        await supabaseClient
          .from("customers")
          .update({
            reward_progress:progress
          })
          .eq("id",customer.id);

        message=progress+"/4 tamamlandı";
      }
    }
  }

  // ZİYARETİ KAYDET
  await supabaseClient.from("visits").insert({
    business_id:businessId,
    customer_phone:phone
  });

  // TOKENI SİL (yenilemede tekrar işlem yapmasın)
  await supabaseClient
    .from("qr_tokens")
    .delete()
    .eq("token",tokenValue);

  localStorage.setItem("revizit_phone_"+businessId,phone);

  showProgress(progress,message);
}

function showProgress(level,message){

  document.getElementById("phoneArea").classList.add("hidden");
  document.getElementById("progressArea").classList.remove("hidden");

  for(let i=1;i<=4;i++){
    const el=document.getElementById("p"+i);
    if(i<=level){
      el.classList.remove("bg-gray-200");
      el.classList.add("bg-black");
    }
  }

  document.getElementById("message").innerText=message;
}

init();

</script>
</body>
</html>
