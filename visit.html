<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret OnayÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="bg-white p-8 rounded-xl shadow w-96 text-center space-y-6">

  <h1 class="text-xl font-bold">Ziyaret OnayÄ±</h1>

  <div id="status"></div>

  <div id="phoneArea" class="hidden space-y-3">
    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-2 w-full rounded text-center text-lg tracking-wider"/>

    <button id="confirmBtn"
      onclick="completeVisit()"
      disabled
      class="bg-gray-300 text-white px-4 py-2 rounded w-full cursor-not-allowed">
      Onayla
    </button>
  </div>

  <div id="cupArea" class="hidden flex flex-col items-center space-y-4">
    <div class="relative w-32 h-40">

      <!-- Cup Outline -->
      <svg viewBox="0 0 120 160" class="absolute inset-0 w-full h-full">
        <path d="M30 20 L90 20 L80 150 L40 150 Z"
              fill="none"
              stroke="#000"
              stroke-width="3"/>
        <!-- Level lines -->
        <line x1="40" y1="115" x2="80" y2="115" stroke="#999" stroke-width="2"/>
        <line x1="40" y1="85" x2="80" y2="85" stroke="#999" stroke-width="2"/>
        <line x1="40" y1="55" x2="80" y2="55" stroke="#999" stroke-width="2"/>
      </svg>

      <!-- Coffee Fill -->
      <div id="coffeeFill"
        class="absolute bottom-0 left-1/2 -translate-x-1/2 w-20 bg-amber-700 rounded-b-lg transition-all duration-700"
        style="height:0%;">
      </div>

    </div>

    <div id="rewardMessage" class="text-sm font-medium"></div>
  </div>

</div>

<script>

const SUPABASE_URL = "https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON
);

let tokenData = null;
let tokenValue = null;

const phoneInput = document.getElementById("phone");
const confirmBtn = document.getElementById("confirmBtn");

/* ================= PHONE FORMAT ================= */

phoneInput?.addEventListener("input", function(e) {

  let digits = e.target.value.replace(/\D/g, "");

  if (digits.length > 11) digits = digits.slice(0, 11);

  let formatted = "";

  if (digits.length > 0) formatted += digits.substring(0, 4);
  if (digits.length >= 5) formatted += " " + digits.substring(4, 7);
  if (digits.length >= 8) formatted += " " + digits.substring(7, 11);

  e.target.value = formatted;

  if (/^05\d{9}$/.test(digits)) {
    confirmBtn.disabled = false;
    confirmBtn.classList.remove("bg-gray-300","cursor-not-allowed");
    confirmBtn.classList.add("bg-black");
  } else {
    confirmBtn.disabled = true;
  }
});

function cleanPhoneNumber(v){ return v.replace(/\D/g,""); }

/* ================= FLOW ================= */

function getTokenFromURL(){
  const params = new URLSearchParams(window.location.search);
  return params.get("token");
}

function showError(msg){
  document.getElementById("status").innerHTML =
    `<p class="text-red-500 text-sm">${msg}</p>`;
}

function showPhoneInput(){
  document.getElementById("status").innerHTML =
    `<p class="text-sm text-gray-500">Telefon numaranÄ±zÄ± girin</p>`;
  document.getElementById("phoneArea").classList.remove("hidden");
}

async function init(){

  tokenValue = getTokenFromURL();
  if(!tokenValue){ showError("GeÃ§ersiz QR."); return; }

  const { data } = await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token", tokenValue)
    .single();

  if(!data){ showError("QR geÃ§ersiz veya kullanÄ±lmÄ±ÅŸ."); return; }

  if(new Date(data.expires_at) < new Date()){
    showError("QR sÃ¼resi dolmuÅŸ.");
    return;
  }

  tokenData = data;
  showPhoneInput();
}

/* ================= VISIT ================= */

async function completeVisit(){

  let phone = cleanPhoneNumber(phoneInput.value);

  if(!/^05\d{9}$/.test(phone)){
    showError("GeÃ§erli numara giriniz.");
    return;
  }

  const businessId = tokenData.business_id;
  const band = tokenData.spending_band;

  let { data: customer } = await supabaseClient
    .from("customers")
    .select("*")
    .eq("phone", phone)
    .eq("business_id", businessId)
    .single();

  let customerId;

  if(!customer){
    const { data:newCustomer } = await supabaseClient
      .from("customers")
      .insert({ phone, business_id:businessId })
      .select().single();
    customerId = newCustomer.id;
  } else {
    customerId = customer.id;
  }

  // GÃ¼nlÃ¼k limit
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);

  const { data:todayVisits } = await supabaseClient
    .from("visits")
    .select("*")
    .eq("business_id", businessId)
    .eq("customer_id", customerId)
    .gte("visit_date", todayStart.toISOString());

  if(todayVisits.length>0){
    showError("BugÃ¼n zaten ziyaret kaydÄ±nÄ±z var.");
    return;
  }

  await supabaseClient
    .from("visits")
    .insert({
      business_id:businessId,
      customer_id:customerId,
      spending_band:band
    });

  await supabaseClient
    .from("qr_tokens")
    .delete()
    .eq("token", tokenValue);

  showCupAnimation(customerId,businessId);
}

/* ================= CUP ANIMATION ================= */

async function showCupAnimation(customerId,businessId){

  document.getElementById("status").innerHTML =
    `<p class="text-green-600 font-semibold">
      KaydÄ±nÄ±z tamamlandÄ±.<br/>Ziyaretiniz baÅŸarÄ±yla kaydedildi.
     </p>`;

  document.getElementById("phoneArea").classList.add("hidden");
  document.getElementById("cupArea").classList.remove("hidden");

  const { data:visits } = await supabaseClient
    .from("visits")
    .select("*")
    .eq("business_id",businessId)
    .eq("customer_id",customerId);

  const visitCount = visits.length;
  const level = visitCount % 4 === 0 ? 4 : visitCount % 4;

  const fillPercent = level * 25;

  setTimeout(()=>{
    document.getElementById("coffeeFill")
      .style.height = fillPercent + "%";
  },200);

  if(level === 4){
    document.getElementById("rewardMessage").innerHTML =
      "ðŸŽ‰ Tebrikler! Ã–dÃ¼l kazandÄ±nÄ±z! Bir sonraki ziyaretinizde ikinci kahveniz bizden.";
  } else {
    document.getElementById("rewardMessage").innerHTML =
      `${level}/4 tamamlandÄ±`;
  }

  setTimeout(()=>{
    window.location.href="about:blank";
  },4000);
}

init();

</script>

</body>
</html>
