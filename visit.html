<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret OnayÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen overflow-hidden">

<div class="bg-white p-8 rounded-2xl shadow-xl w-96 text-center space-y-6 relative">

  <h1 class="text-xl font-bold">Ziyaret OnayÄ±</h1>

  <div id="status"></div>

  <div id="phoneArea" class="hidden space-y-3">
    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-2 w-full rounded text-center text-lg tracking-wider"/>

    <button id="confirmBtn"
      onclick="completeVisit()"
      disabled
      class="bg-gray-300 text-white px-4 py-2 rounded w-full cursor-not-allowed">
      Onayla
    </button>
  </div>

  <div id="cupArea" class="hidden flex flex-col items-center space-y-4">

    <div class="relative w-40">

      <img src="istockphoto-827973744-612x612.jpg"
           class="w-full rounded-xl shadow-md"/>

      <!-- Kahve Dolum -->
      <div id="coffeeFill"
           class="absolute bottom-0 left-0 w-full bg-amber-800 transition-all duration-700"
           style="height:0%; border-radius:0 0 20px 20px;">
      </div>

      <!-- KÃ¶pÃ¼k -->
      <div id="foam"
           class="absolute bottom-0 left-0 w-full bg-white opacity-90 hidden"
           style="height:20%; border-radius:50% 50% 0 0;">
      </div>

    </div>

    <div id="rewardMessage" class="text-sm font-medium"></div>
  </div>

</div>

<script>

const SUPABASE_URL = "https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON
);

let tokenData=null;
let tokenValue=null;

const phoneInput=document.getElementById("phone");
const confirmBtn=document.getElementById("confirmBtn");

/* TELEFON FORMAT */

phoneInput?.addEventListener("input",function(e){
  let digits=e.target.value.replace(/\D/g,"");
  if(digits.length>11) digits=digits.slice(0,11);

  let formatted="";
  if(digits.length>0) formatted+=digits.substring(0,4);
  if(digits.length>=5) formatted+=" "+digits.substring(4,7);
  if(digits.length>=8) formatted+=" "+digits.substring(7,11);

  e.target.value=formatted;

  confirmBtn.disabled=!/^05\d{9}$/.test(digits);
  if(!confirmBtn.disabled){
    confirmBtn.classList.remove("bg-gray-300","cursor-not-allowed");
    confirmBtn.classList.add("bg-black");
  }
});

/* INIT */

function getToken(){
  return new URLSearchParams(window.location.search).get("token");
}

async function init(){
  tokenValue=getToken();
  if(!tokenValue) return;

  const {data}=await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token",tokenValue)
    .single();

  if(!data) return;

  tokenData=data;
  document.getElementById("phoneArea").classList.remove("hidden");
}

/* ANA AKIÅž */

async function completeVisit(){

  const phone=phoneInput.value.replace(/\D/g,"");
  const businessId=tokenData.business_id;

  let {data:customer}=await supabaseClient
    .from("customers")
    .select("*")
    .eq("phone",phone)
    .eq("business_id",businessId)
    .single();

  if(!customer){
    const {data:newCustomer}=await supabaseClient
      .from("customers")
      .insert({
        phone,
        business_id:businessId,
        reward_available:true,
        reward_progress:4
      })
      .select().single();

    await notifyCashier(businessId,"Yeni mÃ¼ÅŸteri Ã¶dÃ¼l kazandÄ± ðŸŽ‰");
    showCup(4,"ðŸŽ‰ Tebrikler! Bir sonraki ziyaretinizde ikinci kahveniz bizden.",true);
    return;
  }

  if(customer.reward_available){
    await supabaseClient
      .from("customers")
      .update({
        reward_available:false,
        reward_progress:1
      })
      .eq("id",customer.id);

    await notifyCashier(businessId,"Ã–dÃ¼l KullanÄ±ldÄ± â˜•");

    showCup(1,"â˜• Hediyenizi kullandÄ±nÄ±z! Yeni kahve yolculuÄŸu baÅŸladÄ±.");
    return;
  }

  let newProgress=customer.reward_progress+1;

  if(newProgress>=4){
    await supabaseClient
      .from("customers")
      .update({
        reward_available:true,
        reward_progress:4
      })
      .eq("id",customer.id);

    showCup(4,"ðŸŽ‰ 4/4 tamamlandÄ±! Bir sonraki ziyaretinizde Ã¼cretsiz kahve kazanacaksÄ±nÄ±z!",true);
  } else {
    await supabaseClient
      .from("customers")
      .update({
        reward_progress:newProgress
      })
      .eq("id",customer.id);

    showCup(newProgress,newProgress+"/4 tamamlandÄ±");
  }
}

/* BARDAK + EFEKT */

function showCup(progress,message,celebrate=false){

  document.getElementById("phoneArea").classList.add("hidden");
  document.getElementById("cupArea").classList.remove("hidden");

  const fill=progress*25;

  setTimeout(()=>{
    document.getElementById("coffeeFill").style.height=fill+"%";
  },200);

  if(celebrate){
    setTimeout(()=>{
      document.getElementById("foam").classList.remove("hidden");
      confetti({particleCount:80,spread:70,origin:{y:0.6}});
    },500);
  }

  document.getElementById("rewardMessage").innerHTML=message;

  setTimeout(()=>{
    window.location.href="about:blank";
  },5000);
}

/* KASÄ°YER BÄ°LDÄ°RÄ°MÄ° */

async function notifyCashier(businessId,message){
  await supabaseClient
    .from("notifications")
    .insert({
      business_id:businessId,
      message:message,
      created_at:new Date()
    });
}

init();

</script>
</body>
</html>
