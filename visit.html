<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white w-[95%] max-w-md min-h-[85vh] 
            rounded-2xl shadow-xl 
            p-8 flex flex-col justify-center 
            text-center space-y-8">

  <h1 class="text-2xl font-bold">Ziyaret Onayı</h1>

  <div id="phoneArea" class="hidden space-y-6">

    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-4 w-full rounded-xl text-center text-xl"/>

    <button id="confirmBtn"
      onclick="completeVisit()"
      disabled
      class="bg-gray-300 text-white px-4 py-4 rounded-xl text-lg w-full">
      Onayla
    </button>

  </div>

  <div id="progressArea" class="hidden space-y-8">

    <div class="grid grid-cols-4 gap-3">
      <div id="p1" class="h-6 rounded-lg bg-gray-200"></div>
      <div id="p2" class="h-6 rounded-lg bg-gray-200"></div>
      <div id="p3" class="h-6 rounded-lg bg-gray-200"></div>
      <div id="p4" class="h-6 rounded-lg bg-gray-200"></div>
    </div>

    <div id="message" class="text-lg font-semibold"></div>

  </div>

</div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let tokenData=null;
let tokenValue=null;

const phoneInput=document.getElementById("phone");
const confirmBtn=document.getElementById("confirmBtn");

phoneInput.addEventListener("input",function(e){
  let digits=e.target.value.replace(/\D/g,"");
  if(digits.length>11) digits=digits.slice(0,11);

  let formatted="";
  if(digits.length>0) formatted+=digits.substring(0,4);
  if(digits.length>=5) formatted+=" "+digits.substring(4,7);
  if(digits.length>=8) formatted+=" "+digits.substring(7,11);

  e.target.value=formatted;

  confirmBtn.disabled=!/^05\d{9}$/.test(digits);

  if(!confirmBtn.disabled){
    confirmBtn.classList.remove("bg-gray-300");
    confirmBtn.classList.add("bg-black");
  }
});

function cleanPhone(v){ return v.replace(/\D/g,""); }

async function init(){

  tokenValue=new URLSearchParams(window.location.search).get("token");

  const {data,error}=await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token",tokenValue)
    .single();

  if(error || !data){
    document.body.innerHTML="QR geçersiz.";
    return;
  }

  tokenData=data;

  const savedPhone=localStorage.getItem("revizit_phone_"+data.business_id);

  if(savedPhone){
    completeVisit(savedPhone,true);
  } else {
    document.getElementById("phoneArea").classList.remove("hidden");
  }
}

async function completeVisit(phoneOverride=null){

  const phone=phoneOverride || cleanPhone(phoneInput.value);
  const businessId=tokenData.business_id;

  const {data:customers}=await supabaseClient
    .from("customers")
    .select("*")
    .eq("business_id",businessId)
    .eq("phone",phone);

  let customer=customers.length>0 ? customers[0] : null;

  if(!customer){

    const {data:newCustomer}=await supabaseClient
      .from("customers")
      .insert({
        phone,
        business_id:businessId,
        reward_available:true,
        reward_progress:4
      })
      .select()
      .single();

    customer=newCustomer;
  }

  // CUSTOMER ID'Yİ KAYDET
  localStorage.setItem("customer_id",customer.id);

  let progress=0;
  let message="";

  if(customer.reward_available){

    progress=1;

    await supabaseClient
      .from("customers")
      .update({
        reward_available:false,
        reward_progress:1
      })
      .eq("id",customer.id);

    message="Hediyenizi kullandınız!";
  }
  else{

    progress=customer.reward_progress+1;

    if(progress>=4){
      progress=4;

      await supabaseClient
        .from("customers")
        .update({
          reward_available:true,
          reward_progress:4
        })
        .eq("id",customer.id);

      message="Yeni ödül kazandınız!";
    }
    else{
      await supabaseClient
        .from("customers")
        .update({
          reward_progress:progress
        })
        .eq("id",customer.id);

      message=progress+"/4 tamamlandı";
    }
  }

  await supabaseClient.from("visits").insert({
    business_id:businessId,
    customer_id:customer.id
  });

  await supabaseClient
    .from("qr_tokens")
    .delete()
    .eq("token",tokenValue);

  localStorage.setItem("revizit_phone_"+businessId,phone);

  showProgress(progress,message);
}

function showProgress(level,message){

  document.getElementById("phoneArea").classList.add("hidden");
  document.getElementById("progressArea").classList.remove("hidden");

  for(let i=1;i<=4;i++){
    const el=document.getElementById("p"+i);
    if(i<=level){
      el.classList.remove("bg-gray-200");
      el.classList.add("bg-black");
    }
  }

  document.getElementById("message").innerText=message;
}

init();

</script>
</body>
</html>
