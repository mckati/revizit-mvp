<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret Onayı</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="bg-white p-8 rounded-xl shadow w-96 text-center space-y-6">

  <h1 class="text-xl font-bold">Ziyaret Onayı</h1>

  <div id="status"></div>

  <div id="phoneArea" class="hidden space-y-3">
    <input id="phone"
      placeholder="05XX XXX XXXX"
      maxlength="13"
      inputmode="numeric"
      class="border p-2 w-full rounded text-center text-lg tracking-wider"/>
    <button onclick="completeVisit()"
      class="bg-black text-white px-4 py-2 rounded w-full">
      Onayla
    </button>
  </div>

</div>

<script>

const SUPABASE_URL = "https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON
);

let tokenData = null;
let tokenValue = null;

/* ========================
   TELEFON FORMAT SİSTEMİ
======================== */

const phoneInput = document.getElementById("phone");

phoneInput?.addEventListener("input", function(e) {

  let digits = e.target.value.replace(/\D/g, "");

  if (digits.length > 11) {
    digits = digits.slice(0, 11);
  }

  // Format: 05XX XXX XXXX
  let formatted = "";

  if (digits.length > 0) {
    formatted += digits.substring(0, 4);
  }
  if (digits.length >= 5) {
    formatted += " " + digits.substring(4, 7);
  }
  if (digits.length >= 8) {
    formatted += " " + digits.substring(7, 11);
  }

  e.target.value = formatted;
});

function cleanPhoneNumber(formattedPhone) {
  return formattedPhone.replace(/\D/g, "");
}

function isValidPhone(phone) {
  return /^05\d{9}$/.test(phone);
}

/* ========================
   GENEL AKIŞ
======================== */

function getTokenFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("token");
}

function showError(message) {
  document.getElementById("status").innerHTML =
    `<p class="text-red-500 text-sm">${message}</p>`;
  document.getElementById("phoneArea").classList.add("hidden");
}

function showSuccess() {
  document.getElementById("status").innerHTML =
    `<p class="text-green-600 font-semibold">Ziyaret başarıyla kaydedildi ✅</p>`;
  document.getElementById("phoneArea").classList.add("hidden");
}

function showPhoneInput() {
  document.getElementById("status").innerHTML =
    `<p class="text-sm text-gray-500">Telefon numaranızı girin</p>`;
  document.getElementById("phoneArea").classList.remove("hidden");
}

async function init() {

  tokenValue = getTokenFromURL();

  if (!tokenValue) {
    showError("Geçersiz QR.");
    return;
  }

  const { data, error } = await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token", tokenValue)
    .single();

  if (error || !data) {
    showError("QR geçersiz veya daha önce kullanılmış.");
    return;
  }

  if (new Date(data.expires_at) < new Date()) {
    showError("QR süresi dolmuş. Lütfen kasiyerden yeni QR isteyin.");
    await supabaseClient
      .from("qr_tokens")
      .delete()
      .eq("token", tokenValue);
    return;
  }

  tokenData = data;

  const savedPhone =
    localStorage.getItem("revizit_phone_" + data.business_id);

  if (savedPhone) {
    await completeVisit(savedPhone, true);
  } else {
    showPhoneInput();
  }
}

async function completeVisit(phoneOverride = null, silent = false) {

  let phone =
    phoneOverride || document.getElementById("phone").value.trim();

  phone = cleanPhoneNumber(phone);

  if (!isValidPhone(phone)) {
    showError("Lütfen 05XX XXX XXXX formatında geçerli bir telefon numarası girin.");
    return;
  }

  const businessId = tokenData.business_id;
  const band = tokenData.spending_band;

  let { data: customer } = await supabaseClient
    .from("customers")
    .select("*")
    .eq("phone", phone)
    .eq("business_id", businessId)
    .single();

  let customerId;

  if (!customer) {
    const { data: newCustomer } = await supabaseClient
      .from("customers")
      .insert({
        phone: phone,
        business_id: businessId
      })
      .select()
      .single();

    customerId = newCustomer.id;
  } else {
    customerId = customer.id;
  }

  // Günlük limit kontrolü
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);

  const todayEnd = new Date();
  todayEnd.setHours(23,59,59,999);

  const { data: todayVisits } = await supabaseClient
    .from("visits")
    .select("*")
    .eq("business_id", businessId)
    .eq("customer_id", customerId)
    .gte("visit_date", todayStart.toISOString())
    .lte("visit_date", todayEnd.toISOString());

  if (todayVisits.length > 0) {

    await supabaseClient
      .from("qr_tokens")
      .delete()
      .eq("token", tokenValue);

    showError("Bugün zaten ziyaret kaydınız bulunmaktadır. Günlük ziyaret kaydı limiti 1 ile sınırlıdır. Anlayışınız için teşekkür ederiz.");
    return;
  }

  const { error } = await supabaseClient
    .from("visits")
    .insert({
      business_id: businessId,
      customer_id: customerId,
      spending_band: band
    });

  if (error) {
    showError("Ziyaret kaydedilemedi.");
    return;
  }

  await supabaseClient
    .from("qr_tokens")
    .delete()
    .eq("token", tokenValue);

  localStorage.setItem(
    "revizit_phone_" + businessId,
    phone
  );

  showSuccess();
}

init();

</script>

</body>
</html>
