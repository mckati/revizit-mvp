<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Ziyaret OnayÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="bg-white p-8 rounded-xl shadow w-96 text-center space-y-6">

  <h1 class="text-xl font-bold">Ziyaret OnayÄ±</h1>

  <div id="status"></div>

  <div id="phoneArea" class="hidden space-y-3">
    <input id="phone"
      placeholder="Telefon NumaranÄ±z"
      class="border p-2 w-full rounded"/>
    <button onclick="completeVisit()"
      class="bg-black text-white px-4 py-2 rounded w-full">
      Onayla
    </button>
  </div>

</div>

<script>

const SUPABASE_URL = "https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON
);

let tokenData = null;
let tokenValue = null;

function getTokenFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("token");
}

function showError(message) {
  document.getElementById("status").innerHTML =
    `<p class="text-red-500">${message}</p>`;
  document.getElementById("phoneArea").classList.add("hidden");
}

function showSuccess() {
  document.getElementById("status").innerHTML =
    `<p class="text-green-600 font-semibold">Ziyaret baÅŸarÄ±yla kaydedildi âœ…</p>`;
  document.getElementById("phoneArea").classList.add("hidden");
}

function showPhoneInput() {
  document.getElementById("status").innerHTML =
    `<p class="text-sm text-gray-500">Telefon numaranÄ±zÄ± girin</p>`;
  document.getElementById("phoneArea").classList.remove("hidden");
}

async function init() {

  tokenValue = getTokenFromURL();

  if (!tokenValue) {
    showError("GeÃ§ersiz QR.");
    return;
  }

  const { data, error } = await supabaseClient
    .from("qr_tokens")
    .select("*")
    .eq("token", tokenValue)
    .single();

  if (error || !data) {
    showError("QR geÃ§ersiz veya daha Ã¶nce kullanÄ±lmÄ±ÅŸ.");
    return;
  }

  if (new Date(data.expires_at) < new Date()) {
    showError("QR sÃ¼resi dolmuÅŸ. LÃ¼tfen kasiyerden yeni QR isteyin.");
    await supabaseClient
      .from("qr_tokens")
      .delete()
      .eq("token", tokenValue);
    return;
  }

  tokenData = data;

  const savedPhone =
    localStorage.getItem("revizit_phone_" + data.business_id);

  if (savedPhone) {
    await completeVisit(savedPhone, true);
  } else {
    showPhoneInput();
  }
}

async function completeVisit(phoneOverride = null, silent = false) {

  const phone =
    phoneOverride || document.getElementById("phone").value;

  if (!phone) {
    showError("Telefon numarasÄ± gerekli.");
    return;
  }

  const businessId = tokenData.business_id;
  const band = tokenData.spending_band;

  // mÃ¼ÅŸteri var mÄ±?
  let { data: customer } = await supabaseClient
    .from("customers")
    .select("*")
    .eq("phone", phone)
    .eq("business_id", businessId)
    .single();

  let customerId;

  if (!customer) {
    const { data: newCustomer } = await supabaseClient
      .from("customers")
      .insert({
        phone: phone,
        business_id: businessId
      })
      .select()
      .single();

    customerId = newCustomer.id;
  } else {
    customerId = customer.id;
  }

  // ðŸ”¥ GÃœNLÃœK LÄ°MÄ°T KONTROLÃœ
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);

  const todayEnd = new Date();
  todayEnd.setHours(23,59,59,999);

  const { data: todayVisits } = await supabaseClient
    .from("visits")
    .select("*")
    .eq("business_id", businessId)
    .eq("customer_id", customerId)
    .gte("visit_date", todayStart.toISOString())
    .lte("visit_date", todayEnd.toISOString());

  if (todayVisits.length > 0) {

    await supabaseClient
      .from("qr_tokens")
      .delete()
      .eq("token", tokenValue);

    showError("BugÃ¼n zaten ziyaret kaydÄ±nÄ±z var.");
    return;
  }

  // ziyaret ekle
  const { error } = await supabaseClient
    .from("visits")
    .insert({
      business_id: businessId,
      customer_id: customerId,
      spending_band: band
    });

  if (error) {
    showError("Ziyaret kaydedilemedi.");
    return;
  }

  // token sil
  await supabaseClient
    .from("qr_tokens")
    .delete()
    .eq("token", tokenValue);

  localStorage.setItem(
    "revizit_phone_" + businessId,
    phone
  );

  showSuccess();
}

init();

</script>

</body>
</html>
