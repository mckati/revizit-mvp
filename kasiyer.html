<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Kasiyer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="bg-white p-8 rounded-xl shadow w-96 text-center">

  <h1 class="text-xl font-bold mb-6">Kasiyer Paneli</h1>

  <!-- 1️⃣ Ziyaret Başlat Butonu -->
  <div id="startArea">
    <button onclick="showBands()" 
      class="w-full bg-black text-white p-3 rounded">
      Ziyaret Başlat
    </button>
  </div>

  <!-- 2️⃣ Harcama Bantları -->
  <div id="bandArea" class="hidden mt-4">
    <p class="mb-4 text-sm text-gray-600">Harcama Bandı Seç</p>

    <button onclick="startVisit('0-250')" class="w-full mb-2 bg-gray-200 p-2 rounded">
      0 - 250
    </button>

    <button onclick="startVisit('251-500')" class="w-full mb-2 bg-gray-200 p-2 rounded">
      251 - 500
    </button>

    <button onclick="startVisit('501-1000')" class="w-full bg-gray-200 p-2 rounded">
      501 - 1000
    </button>
  </div>

  <!-- 3️⃣ QR Alanı -->
  <div id="qrArea" class="hidden mt-6">
    <canvas id="qrcode"></canvas>
    <p class="mt-4 text-sm text-red-500">
      15 saniye geçerli
    </p>
  </div>

</div>

<script>

const supabaseClient = supabase.createClient(
  'https://hyqlhnraoumjsxaxefez.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U'
);

const businessId = 'c95e305c-adde-4dd5-8cc9-40f8c51bbc74';

// Ziyaret başlatınca bantları göster
function showBands() {
  document.getElementById("startArea").classList.add("hidden");
  document.getElementById("bandArea").classList.remove("hidden");
}

async function startVisit(band) {

  const expiresAt = new Date(Date.now() + 15000).toISOString();

  const { data: tokenData, error } = await supabaseClient
    .from("visit_tokens")
    .insert({
      business_id: businessId,
      spending_band: band,
      expires_at: expiresAt
    })
    .select()
    .single();

  if (error) {
    alert("Token oluşturulamadı");
    console.log(error);
    return;
  }

  const tokenId = tokenData.id;

  const qrUrl = window.location.origin + "/scan.html?token=" + tokenId;

  document.getElementById("bandArea").classList.add("hidden");
  document.getElementById("qrArea").classList.remove("hidden");

  QRCode.toCanvas(document.getElementById('qrcode'), qrUrl);

  // 15 saniye sonra reset
  setTimeout(() => {
    resetScreen();
  }, 15000);
}

function resetScreen() {
  document.getElementById("qrArea").classList.add("hidden");
  document.getElementById("bandArea").classList.add("hidden");
  document.getElementById("startArea").classList.remove("hidden");

  const canvas = document.getElementById("qrcode");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

</script>

</body>
</html>
