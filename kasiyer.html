<!DOCTYPE html>
<html>
<head>
  <title>Revizit - Kasiyer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white p-8 rounded-xl shadow w-96 text-center space-y-6">

  <h1 class="text-xl font-bold">Ziyaret Başlat</h1>

  <div id="startArea">
    <button onclick="showBands()"
      class="bg-black text-white px-4 py-2 rounded w-full">
      Ziyaret Başlat
    </button>
  </div>

  <div id="bandArea" class="hidden space-y-2">
    <button onclick="createQR('0-250')" class="w-full border p-2 rounded">0-250</button>
    <button onclick="createQR('251-500')" class="w-full border p-2 rounded">251-500</button>
    <button onclick="createQR('501-1000')" class="w-full border p-2 rounded">501-1000</button>
    <button onclick="createQR('1001+')" class="w-full border p-2 rounded">1001+</button>
  </div>

  <div id="qrArea" class="hidden space-y-4">

    <div id="qrCode" class="flex justify-center"></div>

    <!-- Geri Sayım -->
    <div>
      <div class="w-full bg-gray-200 h-2 rounded">
        <div id="progressBar"
             class="bg-black h-2 rounded transition-all duration-1000"
             style="width:100%"></div>
      </div>
      <p id="countdown" class="text-sm mt-1">15</p>
    </div>

  </div>

</div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";
const BUSINESS_ID="c95e305c-adde-4dd5-8cc9-40f8c51bbc74";

const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let activeToken=null;
let pollInterval=null;
let countdownInterval=null;

function showBands(){
  document.getElementById("startArea").classList.add("hidden");
  document.getElementById("bandArea").classList.remove("hidden");
}

async function createQR(band){

  const token=crypto.randomUUID();
  activeToken=token;

  await supabaseClient.from("qr_tokens").insert({
    token,
    business_id:BUSINESS_ID,
    spending_band:band,
    expires_at:new Date(Date.now()+15000)
  });

  document.getElementById("bandArea").classList.add("hidden");
  document.getElementById("qrArea").classList.remove("hidden");

  const url=window.location.origin+"/visit.html?token="+token;

  document.getElementById("qrCode").innerHTML=
    `<img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}" />`;

  startCountdown();
  startPolling();
}

function startCountdown(){

  let timeLeft=15;

  document.getElementById("countdown").innerText=timeLeft;
  document.getElementById("progressBar").style.width="100%";

  if(countdownInterval){
    clearInterval(countdownInterval);
  }

  countdownInterval=setInterval(()=>{

    timeLeft--;

    document.getElementById("countdown").innerText=timeLeft;

    const percent=(timeLeft/15)*100;
    document.getElementById("progressBar").style.width=percent+"%";

    if(timeLeft<=0){
      resetScreen();
    }

  },1000);
}

function startPolling(){

  if(pollInterval){
    clearInterval(pollInterval);
  }

  pollInterval=setInterval(async()=>{

    if(!activeToken) return;

    const {data}=await supabaseClient
      .from("qr_tokens")
      .select("token")
      .eq("token",activeToken);

    if(!data || data.length===0){
      resetScreen();
    }

  },1000);
}

function resetScreen(){

  document.getElementById("qrArea").classList.add("hidden");
  document.getElementById("startArea").classList.remove("hidden");
  document.getElementById("qrCode").innerHTML="";

  activeToken=null;

  if(pollInterval){
    clearInterval(pollInterval);
    pollInterval=null;
  }

  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval=null;
  }
}

</script>
</body>
</html>
