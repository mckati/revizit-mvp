<!DOCTYPE html>
<html>
<head>
  <title>Revizit - İşletme Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-10">

<div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow">

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold">İşletme Paneli</h1>
    <button onclick="logout()" class="text-sm text-red-500">Çıkış</button>
  </div>

  <!-- KPI -->
  <div class="grid grid-cols-3 gap-4 mb-10 text-center">
    <div class="bg-gray-50 p-4 rounded">
      <p class="text-xs text-gray-500">Toplam Müşteri</p>
      <p id="totalCustomers" class="text-xl font-bold">0</p>
    </div>
    <div class="bg-gray-50 p-4 rounded">
      <p class="text-xs text-gray-500">Toplam Ziyaret</p>
      <p id="totalVisits" class="text-xl font-bold">0</p>
    </div>
    <div class="bg-gray-50 p-4 rounded">
      <p class="text-xs text-gray-500">Tekrar Oranı</p>
      <p id="repeatRate" class="text-xl font-bold">0%</p>
    </div>
  </div>

  <!-- Segment 7 Gün -->
  <h2 class="text-lg font-semibold mb-4">Son 7 Gün Segmentasyonu</h2>
  <div class="grid grid-cols-3 gap-4 text-center mb-8">
    <div class="bg-green-50 p-4 rounded">
      <p class="text-xs">Yeni (1)</p>
      <p id="segmentNew7" class="text-xl font-bold text-green-600">0</p>
    </div>
    <div class="bg-yellow-50 p-4 rounded">
      <p class="text-xs">Gelişen (2-4)</p>
      <p id="segmentGrow7" class="text-xl font-bold text-yellow-600">0</p>
    </div>
    <div class="bg-blue-50 p-4 rounded">
      <p class="text-xs">Sadık (5+)</p>
      <p id="segmentLoyal7" class="text-xl font-bold text-blue-600">0</p>
    </div>
  </div>

  <!-- Segment 30 Gün -->
  <h2 class="text-lg font-semibold mb-4">Son 30 Gün Segmentasyonu</h2>
  <div class="grid grid-cols-3 gap-4 text-center mb-10">
    <div class="bg-green-50 p-4 rounded">
      <p class="text-xs">Yeni (1)</p>
      <p id="segmentNew30" class="text-xl font-bold text-green-600">0</p>
    </div>
    <div class="bg-yellow-50 p-4 rounded">
      <p class="text-xs">Gelişen (2-4)</p>
      <p id="segmentGrow30" class="text-xl font-bold text-yellow-600">0</p>
    </div>
    <div class="bg-blue-50 p-4 rounded">
      <p class="text-xs">Sadık (5+)</p>
      <p id="segmentLoyal30" class="text-xl font-bold text-blue-600">0</p>
    </div>
  </div>

  <!-- 30 Günlük Trend -->
  <h2 class="text-lg font-semibold mb-4">Son 30 Gün Günlük Trend</h2>
  <canvas id="trend30" height="90"></canvas>

  <!-- 7 Gün Saatlik Trend -->
  <h2 class="text-lg font-semibold mt-12 mb-4">Son 7 Gün Saatlik Dağılım</h2>
  <canvas id="trend7hour" height="90"></canvas>

</div>

<script>

const supabaseClient = supabase.createClient(
  'https://hyqlhnraoumjsxaxefez.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U'
);

let businessId;

async function init() {

  const { data } = await supabaseClient.auth.getUser();
  if (!data.user || data.user.user_metadata.role !== "business") {
    window.location.href = "/login.html";
    return;
  }

  businessId = data.user.user_metadata.business_id;

  await loadKPIs();
  await loadSegments(7);
  await loadSegments(30);
  await loadTrend30();
  await loadHourlyTrend7();
}

async function loadKPIs() {

  let { count: totalCustomers } = await supabaseClient
    .from("customers")
    .select("*",{count:"exact",head:true})
    .eq("business_id",businessId);

  let { count: totalVisits } = await supabaseClient
    .from("visits")
    .select("*",{count:"exact",head:true})
    .eq("business_id",businessId);

  let repeatRate = totalCustomers>0
    ? Math.max(0,Math.round((totalVisits/totalCustomers-1)*100))
    : 0;

  document.getElementById("totalCustomers").innerText=totalCustomers||0;
  document.getElementById("totalVisits").innerText=totalVisits||0;
  document.getElementById("repeatRate").innerText=repeatRate+"%";
}

async function loadSegments(days){

  const date=new Date();
  date.setDate(date.getDate()-days);

  const { data: visits } = await supabaseClient
    .from("visits")
    .select("customer_id")
    .eq("business_id",businessId)
    .gte("visit_date",date.toISOString());

  const counts={};
  visits.forEach(v=>{
    counts[v.customer_id]=(counts[v.customer_id]||0)+1;
  });

  let n=0,g=0,l=0;
  Object.values(counts).forEach(c=>{
    if(c===1)n++;
    else if(c<=4)g++;
    else l++;
  });

  if(days===7){
    document.getElementById("segmentNew7").innerText=n;
    document.getElementById("segmentGrow7").innerText=g;
    document.getElementById("segmentLoyal7").innerText=l;
  }else{
    document.getElementById("segmentNew30").innerText=n;
    document.getElementById("segmentGrow30").innerText=g;
    document.getElementById("segmentLoyal30").innerText=l;
  }
}

async function loadTrend30(){

  const today=new Date();
  const start=new Date();
  start.setDate(today.getDate()-30);

  const { data: visits } = await supabaseClient
    .from("visits")
    .select("visit_date")
    .eq("business_id",businessId)
    .gte("visit_date",start.toISOString());

  const daily={};

  visits.forEach(v=>{
    const d=new Date(v.visit_date).toISOString().split("T")[0];
    daily[d]=(daily[d]||0)+1;
  });

  const labels=[],values=[];

  for(let i=30;i>=0;i--){
    const d=new Date();
    d.setDate(today.getDate()-i);
    const key=d.toISOString().split("T")[0];
    labels.push(key.slice(5));
    values.push(daily[key]||0);
  }

  new Chart(document.getElementById("trend30"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[{label:"Toplam Ziyaret",data:values,borderColor:"black"}]
    },
    options:{responsive:true}
  });
}

async function loadHourlyTrend7(){

  const date=new Date();
  date.setDate(date.getDate()-7);

  const { data: visits } = await supabaseClient
    .from("visits")
    .select("visit_date")
    .eq("business_id",businessId)
    .gte("visit_date",date.toISOString());

  const hours=Array(24).fill(0);

  visits.forEach(v=>{
    const h=new Date(v.visit_date).getHours();
    hours[h]++;
  });

  new Chart(document.getElementById("trend7hour"),{
    type:"bar",
    data:{
      labels:Array.from({length:24},(_,i)=>i+":00"),
      datasets:[{label:"Ziyaret Sayısı",data:hours,backgroundColor:"black"}]
    },
    options:{responsive:true}
  });
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="/login.html";
}

init();

</script>

</body>
</html>
