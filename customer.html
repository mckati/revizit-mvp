<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="manifest" href="/manifest.json">

<!-- Status bar rengi -->
<meta name="theme-color" content="#000000">

<title>Revizit - Hesabƒ±m</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-neutral-100 p-6">

<div id="installTopBanner"
     class="hidden bg-black text-white text-sm p-3 rounded-xl mb-4 flex justify-between items-center">

  <span>Revizit‚Äôi ana ekrana ekle ‚òï</span>
  <button id="installTopBtn"
          class="bg-white text-black px-3 py-1 rounded-lg text-xs">
    Ekle
  </button>

</div>

<div id="appToast"
     class="hidden fixed top-6 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded-xl text-sm shadow-lg z-50">
  Uygulama modundasƒ±n ‚òï
</div>

<h1 class="text-2xl font-semibold mb-6 text-center">Hesabƒ±m</h1>
<div id="content" class="space-y-6"></div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let phone = localStorage.getItem("revizit_global_phone");
const customerId = localStorage.getItem("customer_id");
let deferredPrompt=null;

const isStandalone =
  window.matchMedia('(display-mode: standalone)').matches ||
  window.navigator.standalone === true;

if(isStandalone){
  document.body.classList.remove("bg-neutral-100");
  document.body.classList.add("bg-black");
  showAppToast();
}

window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  if(!isStandalone){
    showTopInstallBanner();
  }
});

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/service-worker.js");
}

init();

async function init(){

  if(!phone && customerId){
    const {data:customer} = await supabaseClient
      .from("customers")
      .select("phone")
      .eq("id",customerId)
      .single();

    if(customer){
      phone = customer.phone;
      localStorage.setItem("revizit_global_phone", phone);
    }
  }

  if(!phone){
    document.getElementById("content").innerHTML =
      "<p class='text-center text-white'>M√º≈üteri bulunamadƒ±.</p>";
    return;
  }

  loadData();
  setInterval(loadData,3000);
}

function showTopInstallBanner(){

  if(!deferredPrompt) return;
  if(localStorage.getItem("revizit_installed")) return;

  const banner=document.getElementById("installTopBanner");
  banner.classList.remove("hidden");

  document.getElementById("installTopBtn").onclick=async()=>{
    deferredPrompt.prompt();
    const {outcome}=await deferredPrompt.userChoice;
    if(outcome==="accepted"){
      localStorage.setItem("revizit_installed","true");
      banner.classList.add("hidden");
    }
    deferredPrompt=null;
  };
}

function showAppToast(){
  const toast=document.getElementById("appToast");
  toast.classList.remove("hidden");
  setTimeout(()=>{
    toast.classList.add("hidden");
  },1500);
}

async function loadData(){

  const {data:customers} = await supabaseClient
    .from("customers")
    .select("*")
    .eq("phone", phone);

  if(!customers || customers.length === 0){
    document.getElementById("content").innerHTML =
      "<p class='text-center text-white'>Kayƒ±t bulunamadƒ±.</p>";
    return;
  }

  let html = "";

  for(const customer of customers){

    const {data:business} = await supabaseClient
      .from("businesses")
      .select("name")
      .eq("id", customer.business_id)
      .single();

    let fillPercent = (customer.reward_progress/4)*100;

    html += `
      <div class="bg-white rounded-3xl shadow-xl p-6 text-center space-y-4 mb-6">

        <h2 class="text-lg font-semibold">üìç ${business.name}</h2>

        <div class="relative w-40 mx-auto">
          <svg viewBox="0 0 200 200" class="w-full">
            <path d="M40 50 L160 50 L150 150 L50 150 Z"
                  fill="#E5E5E5" stroke="#CFCFCF" stroke-width="3"/>
            <path d="M160 70 Q190 100 160 130"
                  fill="none" stroke="#CFCFCF" stroke-width="8"/>
            <clipPath id="cupClip${customer.id}">
              <path d="M40 50 L160 50 L150 150 L50 150 Z"/>
            </clipPath>
            <rect x="0"
                  y="${150-fillPercent}"
                  width="200"
                  height="100"
                  fill="#4B2E2B"
                  clip-path="url(#cupClip${customer.id})"/>
          </svg>
        </div>

        <p>${customer.reward_progress} / 4 Ziyaret</p>
    `;

    if(customer.reward_available){
      html += `
        <button
          onclick="requestReward('${customer.id}','${customer.business_id}')"
          class="bg-green-600 text-white w-full py-2 rounded-xl">
          √ñd√ºl√ºn√º Kullan
        </button>
      `;
    }

    html += `</div>`;
  }

  document.getElementById("content").innerHTML = html;
}

async function requestReward(customerId,businessId){

  const {error} = await supabaseClient
    .from("reward_redeem_requests")
    .insert({
      business_id:businessId,
      customer_id:customerId,
      reward_type:"second_coffee_free",
      status:"pending"
    });

  if(error){
    alert("Zaten aktif bir √∂d√ºl talebiniz var.");
  }
}

</script>
</body>
</html>
