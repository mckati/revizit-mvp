<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Revizit - Kahve YolculuÄŸun</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-neutral-100 flex items-center justify-center min-h-screen">

<div class="bg-white w-[360px] rounded-3xl shadow-xl p-6 text-center">

  <h1 class="text-2xl font-semibold mb-6">Kahve YolculuÄŸun</h1>

  <div class="relative w-48 mx-auto mb-6">

    <svg viewBox="0 0 200 200" class="w-full">

      <path d="M40 50 L160 50 L150 150 L50 150 Z"
            fill="#E5E5E5" stroke="#CFCFCF" stroke-width="3"/>

      <path d="M160 70 Q190 100 160 130"
            fill="none" stroke="#CFCFCF" stroke-width="8"/>

      <clipPath id="cupClip">
        <path d="M40 50 L160 50 L150 150 L50 150 Z"/>
      </clipPath>

      <rect id="coffeeFill"
            x="0"
            y="150"
            width="200"
            height="100"
            fill="#4B2E2B"
            clip-path="url(#cupClip)"/>

    </svg>
  </div>

  <p id="visitText" class="text-lg font-medium mb-2"></p>
  <p id="motivText" class="text-green-700 font-medium mb-6"></p>

  <button id="rewardBtn"
          class="w-full py-3 rounded-xl font-semibold transition-all duration-200">
    Ã–dÃ¼lÃ¼nÃ¼ Kullan
  </button>

</div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

const customerId = localStorage.getItem("customer_id");

const coffee = document.getElementById("coffeeFill");
const visitText = document.getElementById("visitText");
const motivText = document.getElementById("motivText");
const btn = document.getElementById("rewardBtn");

if(!customerId){
  document.body.innerHTML="<p class='text-center mt-10'>MÃ¼ÅŸteri bulunamadÄ±. LÃ¼tfen tekrar QR okutun.</p>";
}else{
  loadCustomer();
}

async function loadCustomer(){

  const {data:customer}=await supabaseClient
    .from("customers")
    .select("*")
    .eq("id",customerId)
    .single();

  if(!customer){
    document.body.innerHTML="<p class='text-center mt-10'>MÃ¼ÅŸteri kaydÄ± bulunamadÄ±.</p>";
    return;
  }

  let visits = customer.reward_progress;
  let fillPercent = (visits / 4) * 100;

  coffee.setAttribute("y", 150 - fillPercent);

  visitText.innerText = visits + " / 4 Ziyaret";

  if(visits < 4){

    motivText.innerText = "Ã–dÃ¼l 4. ziyarette aktif olur";

    btn.classList.add("bg-gray-300","text-white");
    btn.disabled = true;
    btn.style.cursor = "not-allowed";
  }

  if(visits === 4 && customer.reward_available){

    motivText.innerText = "Ã–dÃ¼l HazÄ±r ðŸŽ‰";

    btn.classList.add("bg-green-600","text-white","shadow-lg");
    btn.disabled = false;
    btn.style.cursor = "pointer";

    btn.onclick = requestReward;
  }
}

async function requestReward(){

  const {data:customer}=await supabaseClient
    .from("customers")
    .select("business_id")
    .eq("id",customerId)
    .single();

  await supabaseClient
    .from("reward_redeem_requests")
    .insert({
      business_id:customer.business_id,
      customer_id:customerId,
      reward_type:"second_coffee_free",
      status:"pending"
    });

  alert("Talep gÃ¶nderildi. Kasiyer onayÄ±nÄ± bekleyin.");
}

</script>

</body>
</html>
