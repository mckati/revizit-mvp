<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Revizit - Hesabƒ±m</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-neutral-100 p-6">

<h1 class="text-2xl font-semibold mb-6 text-center">Hesabƒ±m</h1>

<div id="content" class="space-y-6"></div>

<script>

const SUPABASE_URL="https://hyqlhnraoumjsxaxefez.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U";

const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

let phone = localStorage.getItem("revizit_global_phone");
const customerId = localStorage.getItem("customer_id");

init();

async function init(){

  // Eƒüer global phone yok ama customer_id varsa fallback yap
  if(!phone && customerId){

    const {data:customer} = await supabaseClient
      .from("customers")
      .select("phone")
      .eq("id",customerId)
      .single();

    if(customer){
      phone = customer.phone;
      localStorage.setItem("revizit_global_phone", phone);
    }
  }

  if(!phone){
    document.getElementById("content").innerHTML =
      "<p class='text-center'>M√º≈üteri bulunamadƒ±.</p>";
    return;
  }

  loadData();
  setInterval(loadData,3000);
}

async function loadData(){

  const {data:customers} = await supabaseClient
    .from("customers")
    .select("*")
    .eq("phone", phone);

  if(!customers || customers.length === 0){
    document.getElementById("content").innerHTML =
      "<p class='text-center'>Kayƒ±t bulunamadƒ±.</p>";
    return;
  }

  // Son ziyaret tarihine g√∂re sƒ±rala
  for(const c of customers){
    const {data:visit} = await supabaseClient
      .from("visits")
      .select("created_at")
      .eq("customer_id", c.id)
      .order("created_at",{ascending:false})
      .limit(1)
      .single();

    c.last_visit = visit ? visit.created_at : null;
  }

  customers.sort((a,b)=>{
    return new Date(b.last_visit || 0) - new Date(a.last_visit || 0);
  });

  let html = "";

  for(const customer of customers){

    const {data:business} = await supabaseClient
      .from("businesses")
      .select("name")
      .eq("id", customer.business_id)
      .single();

    let fillPercent = (customer.reward_progress/4)*100;

    html += `
      <div class="bg-white rounded-3xl shadow-xl p-6 text-center space-y-4">

        <h2 class="text-lg font-semibold">üìç ${business.name}</h2>

        <div class="relative w-40 mx-auto">
          <svg viewBox="0 0 200 200" class="w-full">
            <path d="M40 50 L160 50 L150 150 L50 150 Z"
                  fill="#E5E5E5" stroke="#CFCFCF" stroke-width="3"/>
            <path d="M160 70 Q190 100 160 130"
                  fill="none" stroke="#CFCFCF" stroke-width="8"/>
            <clipPath id="cupClip${customer.id}">
              <path d="M40 50 L160 50 L150 150 L50 150 Z"/>
            </clipPath>
            <rect x="0"
                  y="${150-fillPercent}"
                  width="200"
                  height="100"
                  fill="#4B2E2B"
                  clip-path="url(#cupClip${customer.id})"/>
          </svg>
        </div>

        <p>${customer.reward_progress} / 4 Ziyaret</p>
    `;

    if(customer.reward_available){
      html += `
        <button
          onclick="requestReward('${customer.id}','${customer.business_id}')"
          class="bg-green-600 text-white w-full py-2 rounded-xl">
          √ñd√ºl√ºn√º Kullan
        </button>
      `;
    }

    const {data:history} = await supabaseClient
      .from("rewards_history")
      .select("*")
      .eq("customer_id", customer.id)
      .order("redeemed_at",{ascending:false});

    if(history && history.length > 0){
      html += `<div class="text-sm text-left mt-4 border-t pt-3">`;
      history.forEach(item=>{
        html += `
          <div>
            ${item.reward_type} - 
            ${new Date(item.redeemed_at).toLocaleDateString()}
          </div>
        `;
      });
      html += `</div>`;
    }

    html += `</div>`;
  }

  document.getElementById("content").innerHTML = html;
}

async function requestReward(customerId,businessId){

  await supabaseClient
    .from("reward_redeem_requests")
    .insert({
      business_id:businessId,
      customer_id:customerId,
      reward_type:"second_coffee_free",
      status:"pending"
    });
}

</script>
</body>
</html>
