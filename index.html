<script>
  const supabaseClient = supabase.createClient(
    'https://hyqlhnraoumjsxaxefez.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cWxobnJhb3VtanN4YXhlZmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NzcsImV4cCI6MjA4NzUyODY3N30.GpeVAVBQEoqU_CTw8jehBra4Z5RrAmcEV9qYLp-g02U'
  );

  const businessId = 'c95e305c-adde-4dd5-8cc9-40f8c51bbc74';

  async function addVisit() {
    const phone = document.getElementById("phone").value;

    if (!phone) return;

    let { data: existingCustomer } = await supabaseClient
      .from("customers")
      .select("*")
      .eq("phone", phone)
      .eq("business_id", businessId)
      .single();

    let customerId;

    if (!existingCustomer) {
      let { data: newCustomer } = await supabaseClient
        .from("customers")
        .insert({
          phone: phone,
          business_id: businessId
        })
        .select()
        .single();

      customerId = newCustomer.id;
    } else {
      customerId = existingCustomer.id;
    }

    await supabaseClient
      .from("visits")
      .insert({
        business_id: businessId,
        customer_id: customerId
      });

    // ðŸ”¥ TOPLAM ZÄ°YARETÄ° HESAPLA
    let { data: visitCount } = await supabaseClient
      .from("visits")
      .select("*", { count: "exact" })
      .eq("customer_id", customerId);

    document.getElementById("result").innerText =
      "Toplam ziyaret: " + visitCount.length;

    document.getElementById("phone").value = "";
  }
</script>
